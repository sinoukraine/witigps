<!--suppress JSAnnotator -->
<template>
    <div class="page " data-name="asset-protect"> <!-- page-with-subnavbar -->
        <!-- Top Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="link icon-only back" >
                        <i class="if-not-ios f7-icons icon-header-arrow-back"></i>
                        <i class="if-ios icon icon-back"></i>
                    </a>
                </div>
                <div class="title sliding">
                    {{Name}}
                </div>
                <div class="right">
                    <a href="/asset-edit/?imei={{IMEI}}" class="link icon-only ">
                        <i class="f7-icons icon-header-edit"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="toolbar toolbar-bottom ">
            <div class="toolbar-inner ">
                <a href="/asset-upgrade/?imei={{IMEI}}" class="link button width-100 color-white"><i class="f7-icons icon-upgrade-to-live margin-right"></i>{{@global.LANGUAGE.ASSET_PROTECT_MSG01}}</a>
            </div>
        </div>

        <div class="page-content">

            <div class="block asset-image-big-wrapper text-align-center">
                <a href="/asset-edit/?imei={{IMEI}}" class="link">
                    {{AssetImg}}
                </a>
            </div>

            <div class="list no-hairlines no-chevron " >
                <li class="item-content">
                    <div class="item-media text-color-lightgray">
                        <i class="f7-icons icon-protect-status3"></i>
                    </div>
                    <div class="item-inner">
                        <div class="item-title">{{@global.LANGUAGE.ASSET_STATUS_LIVE_MSG00}}</div>
                        <div class="item-after min-width-122">
                            <a href="/asset-status/?imei={{IMEI}}" class=" width-100 button button-fill color-custom">{{@global.LANGUAGE.COM_MSG048}}</a>
                        </div>
                    </div>
                </li>
                <li class="item-content">
                    <div class="item-media text-color-lightgray">
                        <i class="f7-icons icon-protect-position3"></i>
                    </div>
                    <div class="item-inner">
                        <div class="item-title">{{@global.LANGUAGE.ASSET_PROTECT_MSG00}}</div>
                        <div class="item-after min-width-122">
                            <a  href="/asset-track/?imei={{IMEI}}" class=" width-100 button button-fill color-custom">{{@global.LANGUAGE.COM_MSG048}}</a>
                        </div>
                    </div>
                </li>
                <li class="item-content">
                    <div class="item-media text-color-lightgray">
                        <i class="f7-icons icon-protect-geolock3"></i>
                    </div>
                    <div class="item-inner">
                        <div class="item-title">{{@global.LANGUAGE.ASSET_STATUS_LIVE_MSG04}}</div>
                        <div class="item-after min-width-122 row ">
                            <button @click="changeState('Geolock', false)" class="button button-fill color-custom col {{#unless Geolock}} disabled {{/unless}}">{{@global.LANGUAGE.COM_MSG050}}</button>
                            <button @click="changeState('Geolock', true)" class="button button-fill color-custom col {{#if Geolock}} disabled {{/if}}">{{@global.LANGUAGE.COM_MSG049}}</button>
                        </div>
                    </div>
                </li>
                {{#IsImmobilisationSupported}}
                <li class="item-content">
                    <div class="item-media text-color-lightgray">
                        <i class="f7-icons icon-protect-immobilisation3"></i>
                    </div>
                    <div class="item-inner">
                        <div class="item-title">{{@global.LANGUAGE.ASSET_STATUS_LIVE_MSG05}}</div>
                        <div class="item-after min-width-122 row ">
                            <button @click="changeState('Immobilise', false)" class="button button-fill color-custom col {{#unless Immobilise}} disabled {{/unless}}">{{@global.LANGUAGE.COM_MSG050}}</button>
                            <button @click="changeState('Immobilise', true)" class="button button-fill color-custom col {{#if Immobilise}} disabled {{/if}}">{{@global.LANGUAGE.COM_MSG049}}</button>
                        </div>
                    </div>
                </li>
                {{/if}}
                <li class="item-content">
                    <div class="item-media text-color-lightgray">
                        <i class="f7-icons icon-header-alarm"></i>
                    </div>
                    <div class="item-inner">
                        <div class="item-title">{{@global.LANGUAGE.ASSET_ALARM_MSG00}}</div>
                        <div class="item-after min-width-122">
                            <a href="/asset-alarm/?imei={{IMEI}}" class=" width-100 button button-fill color-custom">{{@global.LANGUAGE.COM_MSG048}}</a>
                        </div>
                    </div>
                </li>
            </div>

        </div>


    </div>
</template>


<script>
    // script must return component object
    return {
        data: function () {
            let self = this;
            let imei = decodeURIComponent(self.$route.query.imei);
            let asset = self.$app.methods.getFromStorage('assetList')[imei];
            let assetImg = self.$app.methods.getAssetImg(asset, {'assetEdit':true});

            let afs = Protocol.Helper.getAssetStateInfo(POSINFOASSETLIST[imei]);

            return {
                Name: asset.Name,
                IMEI: asset.IMEI,
                Id: asset.Id,
                AssetImg: assetImg,

                Geolock: afs && afs.geolock ? afs.geolock.value : false,
                Immobilise: afs && afs.immob ? afs.immob.value : false,

                IsImmobilisationSupported: (parseInt(asset._FIELD_INT2) & 1) > 0,
            };
        },
        methods: {
            changeState: function (alarm, state) {
                let self = this;
                /*let data = {
                    MajorToken: self.$root.MajorToken,
                    MinorToken: self.$root.MinorToken,
                    imei: self.IMEI,
                    state: state ? 'on' : 'off'
                };
                let url = API_URL.URL_SET_GEOLOCK_PROTECT;
                if(alarm === 'Immobilise'){
                    url = API_URL.URL_SET_IMMOBILISATION_PROTECT;
                }

                self.$app.progressbar.show('custom');
                self.$app.request.promise.get(url, data, 'json')
                    .then(function (result) {
                        if (result.data.MajorCode === '000') {
                            if (result.data.MinorCode === '1006') {
                                self.methods.customDialogNoCredit();
                            } else {
                                self.$app.methods.setStatusNewState({
                                    asset: self.IMEI,
                                    forAlarm: alarm,
                                    state: state
                                });
                                self.$setState({ [alarm]: state });
                                self.$app.methods.checkBalance();
                            }
                        } else if (result.data.MajorCode === '100' && result.data.MinorCode === '1006') {
                            self.$app.methods.customDialogNoCredit();
                        } else if (result.data.MajorCode === '200' && result.data.Data && result.data.Data.ERROR === 'NOT_SUPPORT') {
                            self.$app.methods.customDialog({text: LANGUAGE.PROMPT_MSG084});
                        } else {
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG023 + `<br>MajorCode: ${result.data.MajorCode}<br>MinorCode: ${result.data.MinorCode}<br>${result.data.Data}`);
                        }
                    })
                    .finally(function () {
                        self.$app.utils.nextFrame(()=>{
                            self.$app.progressbar.hide();
                        });
                    })
                    .catch(function (err) {
                        console.log(err);
                        if (err && err.status === 404){
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG002);
                        }else{
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG003);
                        }
                    });*/
                let data = {
                    MajorToken: self.$root.MajorToken,
                    MinorToken: self.$root.MinorToken,
                    code: self.Id,
                    state: state ? 'on' : 'off'
                };
                let url = API_URL.SET_GEOLOCK;
                if(alarm === 'Immobilise'){
                    url = API_URL.SET_IMMOBILISATION;
                }

                self.$app.progressbar.show('custom');
                self.$app.request.promise.get(url, data, 'json')
                    .then(function (result) {
                        if (result.data && result.data.MajorCode === '000') {
                            self.$app.methods.setStatusNewState({
                                asset: self.IMEI,
                                forAlarm: alarm,
                                state: state
                            });
                            self.$setState({ [alarm]: state });
                            self.$app.methods.checkBalance();

                        }else if(result.data && result.data.MajorCode === '200' && result.data.MinorCode === '1003'){
                            self.$app.methods.customDialog({title: LANGUAGE.PROMPT_MSG039, text: LANGUAGE.PROMPT_MSG040});

                        }else if(result.data && result.data.MajorCode === '100' && result.data.MinorCode === '1003'){
                            self.$app.methods.customDialog({title: LANGUAGE.PROMPT_MSG039, text: LANGUAGE.PROMPT_MSG040});

                        }else if (result.data && result.data.MajorCode === '100' && result.data.MinorCode === '1006') {
                            self.$app.methods.customDialogNoCredit();

                        }else if(result.data && result.data.MajorCode === '100' && result.data.MinorCode === '0000'){
                            self.$app.methods.customDialog({title: params.imei, text: LANGUAGE.PROMPT_MSG085});

                        }else{
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG023 + `<br>MajorCode: ${result.data.MajorCode}<br>MinorCode: ${result.data.MinorCode}<br>${result.data.Data}`);
                        }
                    })
                    .finally(function () {
                        self.$app.utils.nextFrame(()=>{
                            self.$app.progressbar.hide();
                        });
                    })
                    .catch(function (err) {
                        console.log(err);
                        if (err && err.status === 404){
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG002);
                        }else{
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG003);
                        }
                    });
            }
        },

        on: {
            pageInit: function (e, page) {
                let self = this;



            },
            pageAfterIn:function(){
                let self = this;



            },
            pageAfterOut: function () {
                // page has left the view
            },

        }
    };
</script>